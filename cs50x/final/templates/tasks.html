{% extends "layout.html" %}
{% block title %}â€” Tasks{% endblock %}

{% block head %}
    <style>
        .tasks-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .add-form {
            background: var(--bg2);
            border: 1px solid var(--pdim);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 16px;
            display: none;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 0 30px rgba(124, 58, 237, .08);
        }

        .add-form.open {
            display: flex;
        }

        .form-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .sort-info {
            font-size: 11px;
            color: var(--text3);
            font-family: 'JetBrains Mono', monospace;
            padding: 8px 12px;
            background: var(--bg3);
            border-radius: 6px;
            border: 1px solid var(--border);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .kbd {
            background: var(--surface2);
            border: 1px solid var(--border2);
            border-radius: 4px;
            padding: 1px 6px;
            font-size: 10px;
            color: var(--text3);
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 7px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 11px;
            transition: all .15s;
        }

        .task-item:hover {
            border-color: var(--border2);
            background: var(--surface);
        }

        .task-item.overdue {
            border-color: rgba(248, 113, 113, .25);
            background: rgba(248, 113, 113, .04);
        }

        .check-form {
            display: contents;
        }

        .check-btn {
            width: 20px;
            height: 20px;
            border: 1.5px solid var(--border2);
            border-radius: 6px;
            flex-shrink: 0;
            cursor: pointer;
            background: none;
            color: transparent;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .15s;
        }

        .check-btn:hover {
            border-color: var(--pl);
            background: rgba(124, 58, 237, .08);
            color: var(--pl);
        }

        .task-body {
            flex: 1;
            min-width: 0;
        }

        .task-name {
            font-size: 14px;
            font-weight: 500;
        }

        .task-due {
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text3);
            margin-top: 2px;
        }

        .task-due.overdue-label {
            color: var(--red);
        }

        .task-actions {
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            transition: opacity .15s;
        }

        .task-item:hover .task-actions {
            opacity: 1;
        }

        .edit-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text3);
            cursor: pointer;
            font-size: 11px;
            padding: 3px 9px;
            border-radius: 5px;
            font-family: 'JetBrains Mono', monospace;
            transition: all .15s;
        }

        .edit-btn:hover {
            color: var(--acc);
            border-color: var(--pdim);
        }

        .del-btn {
            background: none;
            border: none;
            color: var(--text3);
            cursor: pointer;
            font-size: 13px;
            padding: 3px 7px;
            border-radius: 4px;
            transition: all .15s;
        }

        .del-btn:hover {
            color: var(--red);
            background: rgba(248, 113, 113, .08);
        }

        .empty {
            text-align: center;
            padding: 48px 20px;
            color: var(--text3);
            font-size: 13px;
            font-family: 'JetBrains Mono', monospace;
        }

        .empty-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

    /* EDIT MODAL */
        .modal-bg {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .6);
            backdrop-filter: blur(4px);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal-bg.open {
            display: flex;
        }

        .modal {
            background: var(--bg2);
            border: 1px solid var(--border2);
            border-radius: 16px;
            padding: 28px;
            width: 100%;
            max-width: 440px;
            position: relative;
        }

        .modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--pl), transparent);
            opacity: .4;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .modal-field {
            margin-bottom: 12px;
        }

        .modal-label {
            display: block;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text3);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .modal-row {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: var(--text3);
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 5px;
            transition: all .15s;
        }

        .modal-close:hover {
            color: var(--text);
            background: var(--surface);
        }
    </style>
{% endblock %}

{% block content %}
    <div class="tasks-header">
        <div class="page-title">Tasks</div>
        <button class="btn-sm" onclick="toggleForm()" id="addToggleBtn">+ Add task</button>
    </div>

    {% if error %}
        <div class="error-msg">{{ error }}</div>
    {% endif %}

    <form method="POST" action="/tasks" id="addForm" class="add-form">
        <input class="inp" type="text" name="text" id="taskInput" placeholder="What needs to get done..." required />
        <div class="form-row">
            <select class="sel" name="priority">
                <option value="high">ðŸ”´ High</option>
                <option value="med" selected>ðŸŸ¡ Medium</option>
                <option value="low">ðŸŸ¢ Low</option>
            </select>
            <input class="inp" type="date" name="due_date" style="max-width:160px;" />
            <button class="btn-sm" type="submit">Add â†’</button>
            <button class="btn-ghost" type="button" onclick="toggleForm()" style="font-size:12px;padding:8px 12px;">Cancel</button>
        </div>
    </form>

    <div class="sort-info">
        <span>â¬¡ Auto-sorted Â· High â†’ Medium â†’ Low</span>
        <span>Press <span class="kbd">N</span> to add task</span>
    </div>

    {% if tasks %}
        <div class="task-list">
            {% for task in tasks %}
                {% set is_overdue = task.due_date and task.due_date < today %}
                <div class="task-item {% if is_overdue %}overdue{% endif %}">
                    <div class="pbar p-{{ task.priority }}"></div>
                    <form class="check-form" method="POST" action="/tasks/complete/{{ task.id }}">
                        <button class="check-btn" type="submit" title="Mark done">âœ“</button>
                    </form>
                    <div class="task-body">
                        <div class="task-name">{{ task.text }}</div>
                        {% if task.due_date %}
                            <div class="task-due {% if is_overdue %}overdue-label{% endif %}">
                                {% if is_overdue %}âš  overdue Â· {% endif %}due {{ task.due_date }}
                            </div>
                        {% endif %}
                    </div>
                    <span class="ptag ptag-{{ task.priority }}">{{ task.priority }}</span>
                    <div class="task-actions">
                        <button class="edit-btn" type="button" onclick="openEdit({{ task.id }}, '{{ task.text|replace("'", "\\'") }}', '{{ task.priority }}', '{{ task.due_date or '' }}')">
                            edit
                        </button>
                        <form class="check-form" method="POST" action="/tasks/delete/{{ task.id }}">
                            <button class="del-btn" type="submit" title="Delete">âœ•</button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty">
            <div class="empty-icon">âš¡</div>
            No tasks. Press <strong>N</strong> or click "+ Add task".
        </div>
    {% endif %}

<!-- EDIT MODAL -->
    <div class="modal-bg" id="editModal">
        <div class="modal">
            <button class="modal-close" onclick="closeEdit()">âœ•</button>
            <div class="modal-title">Edit task</div>
            <form method="POST" id="editForm">
                <div class="modal-field">
                    <label class="modal-label">Task</label>
                    <input class="inp" type="text" name="text" id="editText" required />
                </div>
                <div class="modal-field">
                    <label class="modal-label">Priority</label>
                    <select class="sel" name="priority" id="editPriority" style="width:100%;">
                        <option value="high">ðŸ”´ High</option>
                        <option value="med">ðŸŸ¡ Medium</option>
                        <option value="low">ðŸŸ¢ Low</option>
                    </select>
                </div>
                <div class="modal-field">
                    <label class="modal-label">Due date (optional)</label>
                    <input class="inp" type="date" name="due_date" id="editDue" />
                </div>
                <div class="modal-row">
                    <button class="btn-primary" type="submit">Save changes</button>
                    <button class="btn-ghost" type="button" onclick="closeEdit()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        function toggleForm() {
            const form = document.getElementById('addForm');
            const btn = document.getElementById('addToggleBtn');
            form.classList.toggle('open');
            if (form.classList.contains('open')) {
                document.getElementById('taskInput').focus();
                btn.textContent = 'âœ• Cancel';
            } else {
                btn.textContent = '+ Add task';
            }
        }

        if (new URLSearchParams(window.location.search).get('new') === '1') {
            toggleForm();
        }

        function openEdit(id, text, priority, due) {
            document.getElementById('editText').value = text;
            document.getElementById('editPriority').value = priority;
            document.getElementById('editDue').value = due;
            document.getElementById('editForm').action = '/tasks/edit/' + id;
            document.getElementById('editModal').classList.add('open');
            setTimeout(() => document.getElementById('editText').focus(), 50);
        }

        function closeEdit() {
            document.getElementById('editModal').classList.remove('open');
        }

        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) closeEdit();
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeEdit();
        });
    </script>
{% endblock %}
